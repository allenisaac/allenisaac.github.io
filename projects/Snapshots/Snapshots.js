var thirdRef = [{"Specialty 1": "Named Appt 1",
				"Specialty 2": "Named Appt 2",
				"Specialty 3": "Named Appt 3",
				"Specialty 4": "Named Appt 4",
				"Specialty 5": "Named Appt 5",
				"Specialty 6": "Named Appt 6",
				"Specialty 7": "Named Appt 7",
				"Specialty 8": "Named Appt 8",
				"Specialty 9": "Named Appt 9"}];

var measureRef = [{ "Specialty 1": [
		"Measure 1",
		"Measure 3",
		"Measure 2",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
		"Measure 9",
		"Measure 10",
		"Measure 11",
		"Measure 12"
	],
	"Specialty 4": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
		"Measure 14"
	],
	"Specialty 2": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8"		
	],
	"Specialty 3": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 15",
		"Measure 20",		
		"Measure 8"
	],
	"Specialty 5": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
		"Measure 16"
	],
	"Specialty 7": [
		"Measure 1",
		"Measure 2",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
		"Measure 17"
	],
	"Specialty 6": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
		"Measure 16"
	],
	"Specialty 8": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
		"Measure 18"
	],
	"Specialty 9": [
		"Measure 1",
		"Measure 2",
		"Measure 13",
		"Measure 4",
		"Measure 5",
		"Measure 6",
		"Measure 7",
		"Measure 8",		
	   "Measure 19"
	]}];

var providerRef = [{
		"provider 1":"Specialty 1",
		"provider 2":"Specialty 1",
		"provider 3":"Specialty 1",
		"provider 4":"Specialty 1",
		"provider 5":"Specialty 1",
		"provider 6":"Specialty 1",
		"provider 7":"Specialty 1",
		"provider 8":"Specialty 1",
		"provider 9":"Specialty 1",
		"provider 10":"Specialty 1",
		"provider 11":"Specialty 1",
		"provider 12":"Specialty 1",
		"provider 13":"Specialty 1",
		"provider 14":"Specialty 1",
		"provider 15":"Specialty 1",
		"provider 16":"Specialty 1",
		"provider 17":"Specialty 1",
		"provider 18":"Specialty 1",
		"provider 19":"Specialty 1",
		"provider 20":"Specialty 1",
		"provider 21":"Specialty 1",
		"provider 22":"Specialty 1",
		"provider 23":"Specialty 1",
		"provider 24":"Specialty 1",
		"provider 25":"Specialty 1",
		"provider 26":"Specialty 1",
		"provider 27":"Specialty 1",
		"provider 28":"Specialty 1",
		"provider 29":"Specialty 1",
		"provider 30":"Specialty 1",
		"provider 31":"Specialty 1",
		"provider 32":"Specialty 1",
		"provider 33":"Specialty 1",
		"provider 34":"Specialty 1",
		"provider 35":"Specialty 1",
		"provider 36":"Specialty 1",
		"provider 37":"Specialty 1",
		"provider 38":"Specialty 1",
		"provider 39":"Specialty 1",
		"provider 40":"Specialty 1",
		"provider 41":"Specialty 1",
		"provider 42":"Specialty 1",
		"provider 43":"Specialty 1",
		"provider 44":"Specialty 1",
		"provider 45":"Specialty 1",
		"provider 46":"Specialty 1",
		"provider 47":"Specialty 1",
		"provider 48":"Specialty 1",
		"provider 49":"Specialty 1",
		"provider 50":"Specialty 1",
		"provider 51":"Specialty 1",
		"provider 52":"Specialty 1",
		"provider 53":"Specialty 1",
		"provider 54":"Specialty 1",
		"provider 55":"Specialty 4",
		"provider 56":"Specialty 4",
		"provider 57":"Specialty 4",
		"provider 58":"Specialty 4",
		"provider 59":"Specialty 4",
		"provider 60":"Specialty 4",
		"provider 61":"Specialty 4",
		"provider 62":"Specialty 4",
		"provider 63":"Specialty 4",
		"provider 64":"Specialty 4",
		"provider 65":"Specialty 4",
		"provider 66":"Specialty 4",
		"provider 67":"Specialty 4",
		"provider 68":"Specialty 4",
		"provider 69":"Specialty 2",
		"provider 70":"Specialty 2",
		"provider 71":"Specialty 2",
		"provider 72":"Specialty 3",
		"provider 73":"Specialty 2",
		"provider 74":"Specialty 2",
		"provider 75":"Specialty 2",
		"provider 76":"Specialty 2",
		"provider 77":"Specialty 2",
		"provider 78":"Specialty 2",
		"provider 79":"Specialty 2",
		"provider 80":"Specialty 2",
		"provider 81":"Specialty 3",
		"provider 82":"Specialty 2",
		"provider 83":"Specialty 3",
		"provider 84":"Specialty 2",
		"provider 85":"Specialty 2",
		"provider 86":"Specialty 2",
		"provider 87":"Specialty 2",
		"provider 88":"Specialty 2",
		"provider 89":"Specialty 3",
		"provider 90":"Specialty 2",
		"provider 91":"Specialty 2",
		"provider 92":"Specialty 5",
		"provider 93":"Specialty 5",
		"provider 94":"Specialty 5",
		"provider 95":"Specialty 7",
		"provider 96":"Specialty 7",
		"provider 97":"Specialty 7",
		"provider 98":"Specialty 6",
		"provider 99":"Specialty 6",
		"provider 100":"Specialty 8",
		"provider 101":"Specialty 9"}]


var providerRef2 = [{"value": ["Select..."]},
					{"key":"Specialty 1", "value": [
									"provider 1",
									"provider 2",
									"provider 3",
									"provider 4",
									"provider 5",
									"provider 6",
									"provider 7",
									"provider 8",
									"provider 9",
									"provider 10",
									"provider 11",
									"provider 12",
									"provider 13",
									"provider 14",
									"provider 15",
									"provider 16",
									"provider 17",
									"provider 18",
									"provider 19",
									"provider 20",
									"provider 21",
									"provider 22",
									"provider 23",
									"provider 24",
									"provider 25",
									"provider 26",
									"provider 27",
									"provider 28",
									"provider 29",
									"provider 30",
									"provider 31",
									"provider 32",
									"provider 33",
									"provider 34",
									"provider 35",
									"provider 36",
									"provider 37",
									"provider 38",
									"provider 39",
									"provider 40",
									"provider 41",
									"provider 42",
									"provider 43",
									"provider 44",
									"provider 45",
									"provider 46",
									"provider 47",
									"provider 48",
									"provider 49",
									"provider 50",
									"provider 51",
									"provider 52",
									"provider 53",
									"provider 54"

	]},
	{"key":"Specialty 4","value": [
								"provider 55",
								"provider 56",
								"provider 57",
								"provider 58",
								"provider 59",
								"provider 60",
								"provider 61",
								"provider 62",
								"provider 63",
								"provider 64",
								"provider 65",
								"provider 66",
								"provider 67",
								"provider 68"
								
	]},
	{"key":"Specialty 2","value": [
								"provider 69",
								"provider 70",
								"provider 71",
								"provider 73",
								"provider 74",
								"provider 75",
								"provider 76",
								"provider 77",
								"provider 78",
								"provider 79",
								"provider 80",
								"provider 82",
								"provider 84",
								"provider 85",
								"provider 86",
								"provider 87",
								"provider 88",
								"provider 90",
								"provider 91"
	]},
	{"key":"Specialty 3", "value": [
								"provider 72",
								"provider 81",
								"provider 83",
								"provider 89"

	]},
	{"key":"Specialty 5", "value": [
								"provider 92",
								"provider 93",
								"provider 94"
	]},
	{"key":"Specialty 7","value": [
		"provider 95",
		"provider 96",
		"provider 97"
	]},
	{"key":"Specialty 6","value": [
		"provider 98",
		"provider 99",
	]},
	{"key":"Specialty 8","value": [
		"provider 100"
	]},
	{"key":"Specialty 9","value": [
		"provider 101"
	]}];

// set functions for future formatting (in the table/graph tooltip)	
var parseTime = d3.timeParse("%b-%y"),
	basicFormat = d3.format(",.0f"),
	percentFormat = d3.format(".0%"),
	percentFormat2 = d3.format(".2%"),
	moneyFormat = d3.format("$,.2f"),
	formatValue = d3.format(",.2f"),
	formatDays = function(d) { return (d3.format(",.1f")(d) + " days")}
	bisectDate = d3.bisector(function(d) { return d.Month; }).left;

var windowWidth = d3.select("body").node().getBoundingClientRect().width
var wrapperWidth =  document.getElementsByClassName('unecessary-container')[0].clientWidth;
//reference for formatting by measurement
var measureFormat = [{
	"Measure 1":basicFormat,
	"Measure 2":formatValue,
	"Measure 3":percentFormat,
	"Measure 4":moneyFormat,
	"Measure 5":percentFormat,
	"Measure 6":percentFormat,
	"Measure 7":formatDays,
	"Measure 8":percentFormat,	
	"Measure 9":percentFormat,
	"Measure 10":percentFormat,
	"Measure 11":percentFormat,
	"Measure 12":percentFormat,
	"Measure 13":percentFormat,
	"Measure 14":percentFormat,
	"Measure 15":basicFormat,
	"Measure 20":basicFormat,	
	"Measure 16":percentFormat,
	"Measure 17":percentFormat,
	"Measure 18":percentFormat,
	"Measure 19":percentFormat
}]

//// for resizing
/*
var resizablePref = {bar : 30, bheight: 300, bwidth: 300, lbheight: 300, lwidth:300, theight:300, hwidth:300}
import wixWindow from "wix-window";

wixWindow.getBoundingRect()
  .then( (windowSizeInfo) => {
	let windowHeight = windowSizeInfo.window.height;
	let windowWidth = windowSizeInfo.window.width;
	let documentHeight = windowSizeInfo.document.height;
	let documentWidth = windowSizeInfo.document.width;
	let scrollX = windowSizeInfo.scroll.x;
	let scrollY = windowSizeInfo.scroll.y;
  } );

if (windowWidth < window.innerWidth) {
	//set body width
	//reorder chart width
	if(windowWidth < //some very narrow) {
		//set body width
		//set chart widths
	}
} else {
	if(windowHeight < //some number ) {
		//scale chart height to fit on page
	}
}
*/

var measures =      ["Measure 1",
		"Measure 3",
		"Measure 2",
		"Measure 4",
		"Measure 13",
		"Measure 5",
		"Measure 7",
		"Measure 6",
		"Measure 9",
		"Measure 8",
		"Measure 10",
		"Measure 16",
		"Measure 17",
		"Measure 14",
		"Measure 11",
		"Measure 12",
		"Measure 18",
		"Measure 19"]


var providers = d3.map(providerRef[0]).keys()//.sort(d3.ascending)
var currentMonth = "Oct-18"
var dataLink = 'https://allenisaac.github.io/projects/Snapshots/currentDataCopy.json'


/////################################################################/////
/////#####  SHOULD NOT HAVE TO CHANGE THINGS BEYOND THIS POINT  #####/////
/////################################################################/////

d3.json(dataLink, function(data) {
//	data = data.substring(data.indexOf('[{'),data.indexOf('finalcharactersforjavascript'))
//	data = JSON.parse(data)
	// sort providers by specialty
	for (i in data[0]) {
		for (j in data[0][i][0]) {
			if(include(providers, j)){
				var lookup = measureRef[0][providerRef[0][j]]
				data[0][i][0][j].sort(function(a,b){return (lookup.indexOf(a.Measure) - lookup.indexOf(b.Measure))})
			}
		}
	}
	
	d3.select(".menu-containers").append("svg")
			.attr("height", 1)
			.attr("width","100%")
			.attr("position","absolute")
			.attr("display","inline-block")
	// add dropdowns and functions for changing them
	var selectorProvider = d3.select(".provider-menu-container");


	selectorProvider.append("select")
		.attr("class","menu")
		.selectAll("optgroup")
			.data(providerRef2)
			.enter()
			.append("optgroup")
			.attr("label",function(d) {return d.key})
		.selectAll("option")
			.data(function(d) {return d.value.sort(d3.ascending)})
			.enter()
			.append("option")
				.attr("value", function(d) {return d;})
				.text(function(d) {return d;});

	selectorProvider.on("change", function() {
		var newUser = d3.select(this)
						.select(".menu")
						.property("value");
		updateUser(newUser);

		var newMeasure = selectorMeasure.select(".menu")
										.property("value");
		updateMeasure(newMeasure);

		});

	var selectorMonth = d3.select(".month-menu-container");


	selectorMonth.append("select")
		.attr("class","menu")
		.selectAll("option")
			.data(d3.map(data[0]).keys())
			.enter()
			.append("option")
				.attr("value", function(d) {return d;})
				.text(function(d) {return d;});

	selectorMonth.on("change", function() {
		var newMonth = d3.select(this)
						.select(".menu")
						.property("value");
		updateMonth(newMonth);


		});

	selectorMonth.select(".menu")
				.property("value", currentMonth);

	var selectorMeasure = d3.select(".measure-menu-container");

	selectorMeasure.append("select")
		.attr("class","menu")
		.selectAll("option")
			.data(measures)
			.enter()
			.append("option")
				.attr("value", function(d) {return d;})
				.text(function(d) {return d;});

	selectorMeasure.on("change", function() {
		var newMeasure = d3.select(this)
						.select(".menu")
						.property("value");
		updateMeasure(newMeasure);
		});

// initialize chart settings
	// Quarter to Date compensation/budget goals
	var chart = horizBar()
		.barHeight(20)
		.capitalizeLabels(true)
		.barColors(["steelblue"])
		.currentMonth(currentMonth)
		.domain([0,1.2])
		.tickValues([0,1])
		.transitionDuration(150)
		.width(windowWidth * 0.2593360995850622);//250


	d3.select(".graph1-container")
	  .datum(data)
	  .call(chart);
	
	// Currently selected measure over time		
	 var chart2 = multiLineGraph()
		.currentMonth(currentMonth)
		.timeScale("%b-%y")
		.transitionDuration(500)
		.height(300)
		.width(windowWidth * 0.6742738589211618); //650

	d3.select(".graph2-container")
	  .datum(data)
	  .call(chart2);
	
	// Currently selected measure box and whisker plot
	var chart3 = violinChart()
		.currentMonth(currentMonth)
		.transitionDuration(500)
		.height(300)
		.rectWidth(20)
		.width(windowWidth * 0.2230290456431535); //215

	d3.select(".graph3-container")
	  .datum(data)
	  .call(chart3);

	
	function redraw(){
		wrapperWidth = window.innerWidth - document.getElementsByClassName('main-header-container')[0].clientWidth;
		d3.select('.unecessary-container')
			.attr('width', wrapperWidth)	
		d3.select('.menu-containers')
			.attr('width', wrapperWidth)		
		d3.select('.menu-containers svg')
			.attr('width', wrapperWidth)				
		d3.select('.line-one')
			.attr('width', wrapperWidth)
		d3.select('.line-two')
			.attr('width', wrapperWidth)		
		if(wrapperWidth >= 980) {
			chart.width(wrapperWidth * 0.26)//250
				.margin({top:105, right: 0, bottom:40, left:5});			
			d3.select(".graph1-container")
				.attr('width', wrapperWidth * 0.26)
				.style('padding-top', '90px')
			chart2.width(wrapperWidth * 0.65) //650
					.margin({top:75, right:wrapperWidth * 0.01, bottom:20, left:50});
			d3.select(".graph2-container")
				.attr('width', wrapperWidth * 0.65)					
			chart3.width(wrapperWidth * 0.23) //215
					.margin({top:75, right: 0, bottom:20, left:wrapperWidth * 0.05});
			d3.select(".graph3-container")
				.attr('width', wrapperWidth * 0.23)					
		} else {
			chart.width(wrapperWidth < 500 ? wrapperWidth * 0.94 : 500)//250	
			d3.select(".graph1-container")
				.attr('max-width', wrapperWidth < 500 ? wrapperWidth * 0.94 : 500)		
				.style('padding-top', '0px')				
			chart3.width(wrapperWidth * 0.93)//250
				.margin({top:75, right: 0, bottom:20, left:wrapperWidth * 0.05});
			d3.select(".graph2-container")
				.attr('max-width', wrapperWidth * 0.93)					
			chart2.width(wrapperWidth * 0.92) //650
				.margin({top:75, right:wrapperWidth * 0.03, bottom:20, left:wrapperWidth * 0.04});
			d3.select(".graph3-container")
				.attr('max-width', wrapperWidth * 0.92)				
	}			
		d3.select(".graph1-container")
		  .datum(data)
		  .call(chart);	
		d3.select(".graph2-container")
		  .datum(data)
		  .call(chart2);
		d3.select(".graph3-container")
			.datum(data)
			.call(chart3);
		d3.select('.menu-containers').style('left', 50).raise()
	}	
	
	redraw()
		
	window.addEventListener("resize", redraw);	
	
	
	
	// helper function to return all indexes of a value in an array
	function getAllIndexes(arr, val) {
		var indexes = [], 
			i = -1;
		while ((i = arr.indexOf(val, i+1)) != -1){
			indexes.push(i);
		}
		return indexes;
	}
	// helper function to filter objects by present keys, rather than values (from usual arr.filter(n => n.A == b))
	function filterObject(obj, key) {
		for (var i in obj) {
			if (!obj.hasOwnProperty(i)) continue;
			if (typeof obj[i] == "object") {
				filterObject(obj[i], key);
			} else if (i == key) {
				delete key;
			}
		}
		return obj;
	}



	/*var gLegend = d3.select(".legend-container")
				.append("svg")
				.attr("width", 175)
				.attr("height", 370)
				.append("g")
				.attr("class","legend")
					.attr("transform","translate("+ 20 + ","+ 50 +")");  */

	/*
	gLegend.selectAll(".leg-rect")
		.data(legendData)
		.enter()
		.append("rect")
		.attr("fill",function(d) {return d.color})
		.attr("height",20)
		.attr("width",20)
		.attr("y", function(d) {return 100+40*d.index})
		.attr("x", 0)
		.attr("class","leg-rect")

	//var textObject = d3.select(".legend-container svg")
	//  .append("foreignObject")
	//  .attr("class","fobject")
	//  .attr("width",150)
	//  .attr("height",370)
	//  .text("HELP")

	gLegend.selectAll("foreignObject")
		.data(legendData)
		.enter()
		.append("foreignObject")
		.text(function(d) {return d.line})
		.attr("y", function(d) {return 100+40*d.index})
		.attr("x", 25)
		.attr("width", 150)
		.attr("class","leg-text")
		.style("font-size","12px")
		*/


	function violinChart() {
		var margin = {top:75, right: 0, bottom:20, left:50},
			height = 500,
			width = 200,
			providerColor = undefined,
			transitionDuration = 300,
			rectWidth = 40,
			lineWidth = 1.5,
			boxFill = "white";

		var currentMeasure = undefined,
			currentMonth = undefined,
			currentProvider = undefined,
			currentGoal = false;

		var yScale = null,
			userDataViolin = null,
			descripData = [],
			useDataViolin = null;

		function init(d) {
			yScale = d3.scaleLinear().range([height, 0]);

			userDataViolin = []
			// only interested in currently selected month for box and whisker
			var d2 = d[0][currentMonth]
			for (p in providers) {
				var measCheck = d2[0][providers[p]]
				if (measCheck != undefined){
						measCheck = measCheck.filter(function(i){return i.Measure === currentMeasure})[0]}
				// same specialty
				if (providerRef[0][providers[p]] == providerRef[0][currentProvider]) {
					if (measCheck != null & measCheck != undefined) {
						// add all values of providers in same specialty
						userDataViolin.push(d2[0][providers[p]].filter(function(i){return i.Measure === currentMeasure})[0].Value)
			}}}

			
			userDataViolin = userDataViolin.filter(function(e) {return e !== ""})
			userDataViolin = userDataViolin.map(Number).sort(d3.ascending);
			var months = d3.map(data[0]).keys()
			maxValue = 0
			// set yScale to maximum of all values - so it lines up with line chart
			for (p in providers){
				for (m in months) {
					var interMed = d[0][months[m]][0][providers[p]]
					if (interMed != undefined){
						interMed = interMed.filter(function(i){return i.Measure === currentMeasure})[0]}
					if (interMed != null & interMed != undefined){
					if (interMed.Value > maxValue) {maxValue = interMed.Value}
			}}}

			yScale.domain([0,maxValue > 1 ? maxValue : 1])

			}

		// helper for translation, general margins
		function svgTranslate(x,y) {
			return "translate("+ +x + ","+ +y +")";
		}
		// return quantiles
		function boxQuartiles(d) {
		  return [
			d3.quantile(d, .25),
			d3.quantile(d, .5),
			d3.quantile(d, .75)
		  ];
		}
		// use interquartile range to display outliers as circles rather than whiskers
			// closest value to 1.5 * interquartile range as max/min
		function boxWhiskers(d, iqr) {
			var iqrRange = 1.5*(iqr[2] - iqr[0])
			maxWhisker = iqrRange + iqr[2]
			minWhisker = iqr[0] - iqrRange
			currMax = d[0]
			currMin = d[0]
			for(v in d) {
				if (Math.abs(maxWhisker - d[v]) < Math.abs(maxWhisker - currMax)) {
					currMax = d[v] }//}
			//for(v in d) {
				if (Math.abs(minWhisker - d[v]) < Math.abs(minWhisker - currMin)) {
					currMin = d[v] }}
			return [currMin, currMax]
		}
/*
		function sorter (a,b) {
			return a - b;
		}

		function greaterThan(x, y) { return x > y }
*/

		function initChart(container) {
			//add svg and group
			var g = d3.select(container)
						.append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.attr("class","violin-chart")
							.attr("transform",svgTranslate(margin.left, margin.top));

		}

		function chart(selection) {
			selection.each(function(d) {
				// necessary indicators to create chart
				if(!currentMeasure | !currentProvider) {
					return }

				//if(!currentProvider) {
			//		return }
				init(d);


				if(userDataViolin.length == 0) {
					// remove axes if there's no data
					d3.selectAll(".violin-chart > :not(.axis)").remove()
					return }
				var quartileData = boxQuartiles(userDataViolin)

				var whiskerData = boxWhiskers(userDataViolin, quartileData),
					outlierData = userDataViolin.filter(function(x){ return x > whiskerData[1] || x < whiskerData[0]})//points outside whiskers

				whiskerData = [{"Min": whiskerData[0], "Max": whiskerData[1]}]
				quartileData = [{"twofive": quartileData[0],"median": quartileData[1], "sevenfive":quartileData[2]}]
				var g = d3.select(this).select("svg g.violin-chart");
				// check if chart is created
				var update = g["_groups"][0][0] !== undefined;  // true if data is being updated
				//add svg if this is first time creating chart
				if(!update)
					initChart(this);

				g = d3.select(this).select("svg g.violin-chart");

	/*          var boxLayers = g.selectAll(".boxLayer")
					.append("g")
					.classed("boxLayer", true);*/
					
			// add lines and points by binding data, so changes are animated (Provider, Measure, Month)
				// keeps changes more easily understood
				var vertLines = d3.selectAll("svg g.violin-chart").selectAll(".vert-lines")
					.data(whiskerData);

				vertLines.enter()
					.append("line")
					.classed("vert-lines",true);

				vertLines.exit().remove();

				d3.selectAll(".vert-lines").transition()
					.duration(transitionDuration)
					.attr("x1", (1/4)*width/2)
					.attr("x2",(1/4)*width/2)
					.attr("y1", function(d) {return yScale(d.Min)})
					.attr("y2",  function(d) {return yScale(d.Max)})
					.attr("stroke","#000")
					.attr("stroke-width",lineWidth)
					.attr("fill","none")
				//  .attr("class","vert-lines")

				var interQuart = d3.selectAll("svg g.violin-chart").selectAll(".rect-quart")
					.data(quartileData);

				interQuart.enter()
					.append("rect")
					.classed("rect-quart", true);

				interQuart.exit().remove();

				d3.selectAll(".rect-quart").transition()
					.duration(transitionDuration)
					.attr("x", ((1/4)*width - rectWidth)/2)
					.attr("y", function(d){return yScale(d.sevenfive)})
					.attr("height", function(d) { return (yScale(d.twofive) - yScale(d.sevenfive))})
					.attr("width", rectWidth)
					.attr("stroke","#000")
					.attr("stroke-width",lineWidth)
					.attr("fill",boxFill)

				var medLines = d3.selectAll("svg g.violin-chart").selectAll(".med-line")
					.data(quartileData);

				medLines.enter()
					.append("line")
					.classed("med-line", true);

				medLines.exit().remove();

				d3.selectAll(".med-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth)/2 )
					.attr("x2",((1/4)*width+rectWidth)/2)
					.attr("y1", function(d) {return yScale(d.median)})
					.attr("y2", function(d) {return yScale(d.median)})
					.attr("stroke","#000")
					.attr("stroke-width",lineWidth)
					.attr("fill","none")

				var maxLines = d3.selectAll("svg g.violin-chart").selectAll(".max-line")
					.data(whiskerData);

				maxLines.enter()
					.append("line")
					.classed("max-line", true);

				maxLines.exit().remove();

				d3.selectAll(".max-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth)/2 )
					.attr("x2",((1/4)*width+rectWidth)/2)
					.attr("y1", function(d) {return yScale(d.Max)})
					.attr("y2", function(d) {return yScale(d.Max)})
					.attr("stroke","#000")
					.attr("stroke-width",lineWidth)
					.attr("fill","none")

				var minLines = d3.selectAll("svg g.violin-chart").selectAll(".min-line")
					.data(whiskerData);

				minLines.enter()
					.append("line")
					.classed("min-line", true);

				minLines.exit().remove();

				d3.selectAll(".min-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth)/2 )
					.attr("x2",((1/4)*width+rectWidth)/2)
					.attr("y1", function(d) {return yScale(d.Min)})
					.attr("y2", function(d) {return yScale(d.Min)})
					.attr("stroke","#000")
					.attr("stroke-width",lineWidth)
					.attr("fill","none")

				var outliers = d3.selectAll("svg g.violin-chart").selectAll(".outlier")
					.data(outlierData);

				outliers.enter()
					.append("circle")
					.classed("outlier", true);

				outliers.exit().remove();

				d3.selectAll(".outlier").transition()
					.duration(transitionDuration)
					.attr("r", 5)
					.attr("cx",((1/4)*width)/2)
					.attr("cy", function(d) {return yScale(d)})
					.attr("stroke","#000")
					.attr("opacity",0.7)
				//  .attr("stroke-width",lineWidth)
					.attr("fill","none")


				var userLine = d3.selectAll("svg g.violin-chart").selectAll(".user-line")
					.data(d[0][currentMonth][0][currentProvider].filter(function(i){return i.Measure === currentMeasure}));

				userLine.enter()
					.append("line")
					.classed("user-line", true);

				userLine.exit().remove();
				d3.selectAll(".user-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth - 10)/2 )
					.attr("x2",((1/4)*width+rectWidth+ 10)/2)
					.attr("y1", function(d){return yScale(d.Value)})
					.attr("y2", function(d){return yScale(d.Value)})
					.attr("stroke","#376374")
					.attr("stroke-width",lineWidth + 2)
					.attr("fill","none");

				var qualLine = d3.selectAll("svg g.violin-chart").selectAll(".qual-box-line")
					.data(d[0][currentMonth][0][currentProvider].filter(function(i){return i.Measure === currentMeasure}));

				qualLine.enter()
					.append("line")
					.classed("qual-box-line box-goal", true);

				qualLine.exit().remove();
				d3.selectAll(".qual-box-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth - 10)/2 )
					.attr("x2",((1/4)*width+rectWidth+ 10)/2)
					.attr("y1", function(d){ if(d["Quality Goal"] != null) {return yScale(d["Quality Goal"])}})
					.attr("y2", function(d){if(d["Quality Goal"] != null) {return yScale(d["Quality Goal"])}})
					.attr("stroke","#B9A154")
					.attr("stroke-width",lineWidth + 2)
					.attr("fill","none")
					.attr("opacity", function(d){ if(d["Quality Goal"] != null) {return 1} else { return 0}})


				var compLine = d3.selectAll("svg g.violin-chart").selectAll(".comp-box-line")
					.data(d[0][currentMonth][0][currentProvider].filter(function(i){return i.Measure === currentMeasure}));

				compLine.enter()
					.append("line")
					.classed("comp-box-line box-goal", true);

				compLine.exit().remove();
				d3.selectAll(".comp-box-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth - 10)/2 )
					.attr("x2",((1/4)*width+rectWidth+ 10)/2)
					.attr("y1", function(d){ if(d["Compensation Threshold"] != null) {return yScale(d["Compensation Threshold"])}})
					.attr("y2", function(d){if(d["Compensation Threshold"] != null) {return yScale(d["Compensation Threshold"])}})
					.attr("stroke","#db3232")
					.attr("stroke-width",lineWidth + 2)
					.attr("fill","none")
					.attr("opacity", function(d){ if(d["Compensation Threshold"] != null) {return 1} else { return 0}})


				var budgLine = d3.selectAll("svg g.violin-chart").selectAll(".budg-box-line")
					.data(d[0][currentMonth][0][currentProvider].filter(function(i){return i.Measure === currentMeasure}));

				budgLine.enter()
					.append("line")
					.classed("budg-box-line box-goal", true);

				budgLine.exit().remove();
				d3.selectAll(".budg-box-line").transition()
					.duration(transitionDuration)
					.attr("x1", ((1/4)*width-rectWidth - 10)/2 )
					.attr("x2",((1/4)*width+rectWidth+ 10)/2)
					.attr("y1", function(d){ if(d["Budgeted Goal"] != null) {return yScale(d["Budgeted Goal"])}})
					.attr("y2", function(d){if(d["Budgeted Goal"] != null) {return yScale(d["Budgeted Goal"])}})
					.attr("stroke","#db3232")
					.attr("stroke-width",lineWidth + 2)
					.attr("fill","none")
					.attr("opacity", function(d){ if(d["Budgeted Goal"] != null) {return 1} else { return 0}})
				var userValue = d[0][currentMonth][0][currentProvider].filter(function(i){return i.Measure === currentMeasure})[0].Value

			//  d3.selectAll(".perc-text").remove()
				// display percentile
				var percentileText = d3.select("svg g.violin-chart").selectAll(".perc-text")
					.data([userValue])
				percentileText.enter()
					.append("text")
					.classed("perc-text", true)

				percentileText.exit().remove()

				d3.selectAll(".perc-text").transition()
					.duration(transitionDuration)
					.attr("x", (3*width/10))
					.attr("y", yScale(userValue)+4)
					.text(ordinal_suffix_of(d3.format(".0f")(100*percentRank(userDataViolin, userValue)))+ " Percentile")

				//y axis based on current measure format
				var yAxis = d3.axisLeft(yScale).tickSize(width/4).tickFormat(measureFormat[0][currentMeasure])

				g.selectAll(".axis").remove()

				g.append("g")
					.attr("class","axis y-axis")
					.attr("transform", "translate("+ width/4 + ", 0)")
					.transition()
					.duration(transitionDuration)
					.call(yAxis)


				g.selectAll(".y-axis .tick:not(:first-of-type) line").attr("stroke", "#777").attr("stroke-dasharray", "2,2");
				  g.selectAll(".y-axis .tick text").attr("dx", 0).attr("dy", -4);
				g.select(".y-axis .domain").remove();
				
				g.selectAll(".box-title").remove()
				// title is month
				g.append("text")
					.attr("class","box-title")
					.attr("x", 0)
					.attr("y", 0 -(margin.top/2))
					.attr("text-decoration", "underline")
					.style("font-size","22px")
					.text(currentMonth)




			});
		}
		chart.margin = function(_) {
			if (!arguments.length) return margin;
			margin = _;
			return chart;
		};
		chart.height = function(_) {
			if (!arguments.length) return height;
			height = _;
			return chart;
		};
		chart.width = function(_) {
			if (!arguments.length) return width;
			width = _;
			return chart;
		};
		chart.providerColor = function(_) {
			if (!arguments.length) return providerColor;
			providerColor = _;
			return chart;
		};
		chart.transitionDuration = function(_) {
			if (!arguments.length) return transitionDuration;
			transitionDuration = _;
			return chart;
		};
		chart.rectWidth = function(_) {
			if (!arguments.length) return rectWidth;
			rectWidth = _;
			return chart;
		};
		chart.lineWidth = function(_) {
			if (!arguments.length) return lineWidth;
			lineWidth = _;
			return chart;
		};
		chart.currentMeasure = function(_) {
			if (!arguments.length) return currentMeasure;
			currentMeasure = _;
			return chart;
		};
		chart.currentMonth = function(_) {
			if (!arguments.length) return currentMonth;
			currentMonth = _;
			return chart;
		};
		chart.currentProvider = function(_) {
			if (!arguments.length) return currentProvider;
			currentProvider = _;
			return chart;
		};
		chart.currentGoal = function(_) {
			if (!arguments.length) return currentGoal;
			currentGoal = _;
			return chart;
		};
		chart.yScale = function(_) {
			if (!arguments.length) return yScale;
			yScale = _;
			return chart;
		};
		chart.useDataViolin = function(_) {
			if (!arguments.length) return useDataViolin;
			useDataViolin = _;
			return chart;
		};
		chart.userDataViolin = function(_) {
			if (!arguments.length) return userDataViolin;
			userDataViolin = _;
			return chart;
		};


		return chart
	}


	function tableChart(dat, selection){
		// create data to bind to legend elements
		var legendData = [{"line": selectorProvider.select(".menu").property("value"), "color": "#376374", "index":0}, {"line": "Quality Goal", "color":"#B9A154", "index":1}, {"line": "Compensation Threshold & Budgeted Goal", "color": "#db3232", "index":2}]

		var columns = ["Full Measure","Patients Seen","Value","Quality Goal","Compensation Threshold", "Budgeted Goal"]
		var table = selection.append("table"),
			thead = table.append("thead"),
			tbody = table.append("tbody");
		table.attr("class","table-chart")

		thead.append("tr")
			.selectAll("th")
			.data(columns).enter()
			.append("th")
				.text(function(column) {return column;});

		var rows = tbody.selectAll("tr")
			.data(dat)
			.enter()
			.append("tr");
		var cells = rows.selectAll("td")
			.data(function(row) {
				return columns.map(function(column) {
					if(column != "Patients Seen" & column != "Full Measure"){
						// return correct formatting, based on measure
						if(row['Measure'] == 'Measure 7' & column == 'Value') {
							return {column: column, value: measureFormat[0][row["Measure"]](row[column] == "" ? 0 : row[column])}
						} else if(row[column]){
						return {column: column, value: measureFormat[0][row["Measure"]](row[column])}
							}  else {return {column: column, value: row[column]}
					}} else {
						if (row[column] == "Measure 7") { return {column: column, value: ("Measure 7 " + thirdRef[0][providerRef[0][selectorProvider.select(".menu").property("value")]])}
						} else {
							return {column: column, value: row[column]}}}
					//  if(row[column] < 1.01) {return {column: column, value: (d3.format(".0%")(row[column]))}
					//  } else if (row[column] > 1000) { return {column: column, value: ("$" + formatValue(row[column]))}
					//  } else {return {column: column, value: row[column]}}} else {return {column: column, value:row[column]}};
					
				});
			})
			.enter()
			.append("td")
				.text(function(d) {return d.value; });

		// calculate YTD values and insert after similarly monthly values
		var yearlyMonths = d3.map(data[0]).keys().filter(function(n) {return n.indexOf(d3.select('.month-menu-container select').property('value').slice(-2)) > -1})
		yearlyMonths = yearlyMonths.filter(function(n) {return parseTime(n) <= parseTime(d3.select('.month-menu-container select').property('value'))})
		var YTDrevP = d3.select('.provider-menu-container select').property('value')
		var YTDrevV = 0
		var YTDrevB = 0
		var YTDrvuV = 0
		var YTDrvuB = 0
		yearlyMonths.forEach(function(i) { try{ var YTDrevR= data[0][i][0][YTDrevP].filter(function(n) {return n.Measure == 'Measure 4'});
											var YTDrvuR = data[0][i][0][YTDrevP].filter(function(n) {return n.Measure == 'Measure 2'});
											YTDrevV += YTDrevR[0].Value;
											YTDrvuV += YTDrvuR[0].Value;
											YTDrevB += YTDrevR[0]['Budgeted Goal']; 
											YTDrvuB += YTDrvuR[0]['Budgeted Goal'];
											} catch(err){}})
											
		var whichRow = 0
		var child = d3.selectAll('td').filter(function() {
			return d3.select(this).text() == 'Measure 4'})
					.select(function(){ return this.parentNode;})._groups[0][0]
		while ((child = child.previousSibling) != null)
			whichRow += 1;
		var YTDrev = tbody.insert('tr','tr:nth-of-type(' +(whichRow+2) + ')')
			
		YTDrev.selectAll('td')
			.data([{column: 'Measure',value:'Measure 4 (YTD)'},
					{column:'Patients Seen',value:''},
					{column:'Value',value:YTDrevV},
					{column:'Quality Goal',value:''},
					{column:'Compensation Threshold',value:''},
					{column:'Budgeted Goal', value:YTDrevB}])
			.enter()
			.append('td')
			.text(function(d) {return d.column =='Value' | d.column == 'Budgeted Goal' ? moneyFormat(d.value) : d.value;});
		
		var whichRowRVU = 0
		var child = d3.selectAll('td').filter(function() {
			return d3.select(this).text() == 'Measure 2'})
					.select(function(){ return this.parentNode;})._groups[0][0]
		while ((child = child.previousSibling) != null)
			whichRowRVU += 1;

		var YTDrvu = tbody.insert('tr','tr:nth-of-type(' +(whichRowRVU+2) + ')')				
		YTDrvu.selectAll('td')
			.data([{column: 'Measure',value:'Measure 2 (YTD)'},
					{column:'Patients Seen',value:''},
					{column:'Value',value:YTDrvuV},
					{column:'Quality Goal',value:''},
					{column:'Compensation Threshold',value:''},
					{column:'Budgeted Goal', value:YTDrvuB}])
			.enter()
			.append('td')
			.text(function(d) {return d.column =='Value' | d.column == 'Budgeted Goal' ? formatValue(d.value) : d.value;});		
			
		selection.select("svg").remove()
		tableDim = d3.select(".table-chart").node().getBoundingClientRect()
		var tempHeight = (d3.select(".graph1-container").node().getBoundingClientRect().height - 25 - tableDim.height)
		var svg = selection.append("svg")
					.attr("transform","translate("+ 0 + ","+ 0 +")")
					.attr("width",tableDim.width)
					.attr("height",50);
		// add in legend
		svg.selectAll(".leg-rect")
			.data(legendData)
			.enter()
			.append("rect")
			.attr("fill",function(d) {return d.color})
			.attr("height",20)
			.attr("width",20)
			.attr("x", function(d) {return 10+(tableDim.width/4)*d.index})
			.attr("y", svg.node().getBoundingClientRect().height - 30)
			.attr("class","leg-rect")

		svg.selectAll("foreignObject")
		.data(legendData)
		.enter()
		.append("foreignObject")
		.text(function(d) {return d.line})
		.attr("x", function(d) {return 40 + (tableDim.width/4)*d.index})
		.attr("y", svg.node().getBoundingClientRect().height - 28)
		.attr("width", 250)
		.attr("class","leg-text")
		.style("font-size","14px")

		// append called data to rows
		var newDat = JSON.parse(JSON.stringify(dat))
		rows.data(newDat)
		
		//change graphs when click on the row
		rows.on("click", function(d) {
			console.log(d)
			if(d.Measure != undefined){
			selectorMeasure.select(".menu")
				.property("value", d.Measure);
			updateMeasure(d.Measure);}
		});
		return table;
	}

	function multiLineGraph() {

		//configurables
		var margin = {top:75, right: 5, bottom:20, left:25},
			height = 500,
			width = 900,
			timeScale = undefined
			transitionDuration = 300;

		var currentMeasure = undefined,
			currentMonth = undefined,
			currentProvider = undefined,
			currentGoal = false;
		// scales
		var numLines = null,
			xScale = null,
			yScale = null,
			zScale = null,
			line = null,
			focus = null,
			useDataline = null,
			circleScale = null;


		function init(d) {

			// set scales and axes
			yScale = d3.scaleLinear().range([height, 0])
			xScale = d3.scaleTime().range([20,width - 20]).domain([d3.timeMonth.offset(parseTime(currentMonth), -11), parseTime(currentMonth)]);
			zScale = d3.scaleOrdinal(d3.schemeCategory10);
			xAxis = d3.axisBottom(xScale).ticks(d3.timeMonth)
			yAxis = d3.axisRight(yScale).tickSize(width).tickFormat(measureFormat[0][currentMeasure])
			circleScale = d3.scaleSqrt().range([6,18])
			var fullMonths = d3.timeMonth.range(xScale.domain()[0],xScale.domain()[1])
			fullMonths.push(xScale.domain()[1])
			var allMonths = d3.map(data[0]).keys()

			var months = []
			for (i in fullMonths) {
				simpMonth = (fullMonths[i].toString().slice(4,7) + "-" + fullMonths[i].toString().slice(13,15))
				months.push(simpMonth)
				}
			months =  months.filter(function(n){return include(allMonths,n)})
			useDataLine = [{}]

			maxValue = 0
			maxSeen = 0
			var currentProviderList = providers.filter(function(v, i, arr){return i in getAllIndexes(d3.map(providerRef[0]).values(), "Specialty 1");})
			// change data for use in line graph
				// get domain for values (line height) and patient seen (circle radius)
			for (p in providers){
				useDataLine[p] = {"key" : providers[p], "value" : []}
				useDataLine[p]["key"] = providers[p]
				useDataLine[p]["value"] = []
				for (m in months) {
					var interMed = d[0][months[m]][0][providers[p]]
					if (interMed != undefined){
						interMed = interMed.filter(function(i){return i.Measure === currentMeasure})[0]}
					if (interMed != null & interMed != undefined){
					if (interMed.Value > maxValue) {maxValue = interMed.Value};
					if (interMed["Patients Seen"] > maxSeen) {maxSeen = interMed["Patients Seen"]};
					var innerData = {"Month": parseTime(months[m]),
									"Measure":currentMeasure,
									"Value": interMed.Value,
									"Score": interMed.Score,
									"Patients Seen": interMed["Patients Seen"],
									"Compensation Threshold": interMed["Compensation Threshold"],
									"Quality Goal": interMed["Quality Goal"],
									"Budgeted Goal": interMed["Budgeted Goal"]}
					useDataLine[p]["value"].push(innerData)}}}


			
			yScale.domain([0, maxValue >= 1? maxValue: 1])
			circleScale.domain([0, maxSeen])
			
			// functions for drawing graph
			line = d3.line()//.curve(d3.curveNatural)
				.defined(function(d) { return d.Value != null; })
				.x(function(d) { return xScale(d.Month);})
				.y(function(d) {return yScale(d.Value);});

			qualityGoal = d3.line()
				.defined(function(d) { return d["Quality Goal"] != null; })
				.x(function(d){return xScale(d.Month);})
				.y(function(d){return yScale(d["Quality Goal"]);});

			compGoal = d3.line()
				.defined(function(d) { return d["Compensation Threshold"] != null; })
				.x(function(d){return xScale(d.Month);})
				.y(function(d){return yScale(d["Compensation Threshold"]);});

			budgGoal = d3.line()
				.defined(function(d) { return d["Budgeted Goal"] != null; })
				.x(function(d){return xScale(d.Month);})
				.y(function(d){return yScale(d["Budgeted Goal"]);});


		}

		function svgTranslate(x,y){
			return "translate("+ +x + ","+ +y +")";
		}

		function initChart(container) {
			// add svg and group on initial load
			var g = d3.select(container)
						.append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.attr("class","line-chart")
							.attr("transform",svgTranslate(margin.left, margin.top));

		}

		function mousemove1() {
			// function for displaying tooltip
				// uses inverse of mouse to place tooltip based on scales (lines up with points)
			var currentTip = useDataLine.filter(function(d) { return d.key === currentProvider})[0].value,
				x0 = xScale.invert(d3.mouse(this)[0]),
				i = bisectDate(currentTip, x0, 1),
				d0 = currentTip[i-1],
				d1 = currentTip[i],
				d = x0 - d0.Month > d1.Month - x0 ? d1:d0;
			// so it's never cut off
			var isLeft = (xScale(d.Month) < width/2),
				isTop = (yScale(d.Value) < height/2);
			// use data to create display text
			var nameDisplay = (d.Month.toString().slice(4,7)  + "-" + d.Month.toString().slice(13,15)),
				valueDisplay = "Score: " + d.Value
			if(d["Patients Seen"] == undefined) { var seenDisplay = ""} else {var seenDisplay = d["Patients Seen"] + " Patients Seen";}
			if(d["Quality Goal"] == undefined) {var goalDisplay = ""} else {var goalDisplay = "Quality Goal: " + measureFormat[0][d.Measure](d["Quality Goal"])}
			if(d["Compensation Threshold"] == undefined || d["Compensation Threshold"] === "") {var compDisplay = ""} else {var compDisplay = "Comp Goal: " + measureFormat[0][d.Measure](d["Compensation Threshold"])}
			if(d["Budgeted Goal"] == undefined) {var budgDisplay = ""} else {var budgDisplay = "Budgeted: " + measureFormat[0][d.Measure](d["Budgeted Goal"])}
			var valueDisplay = "Score: " + measureFormat[0][d.Measure](d["Value"])

			// add text to various lines - not all measures use all 
			focus.select(".line-name").text(nameDisplay)
			focus.select(".line-goal").text(goalDisplay).attr("dy", function() {if(compDisplay  === "" & budgDisplay === ""){return "4.05em"}else {return "5.4em"}})
			focus.select(".line-value").text(valueDisplay)
			focus.select(".line-seen").text(seenDisplay).attr("dy", function() {if(compDisplay  === "" & budgDisplay === ""){return "5.4em"}else{return "6.75em"}})
			focus.select(".line-comp").text(compDisplay)
			focus.select(".line-budg").text(budgDisplay)
			//find widest text, and set background box accordingly
			var dimHeight = (compDisplay !== "") + (budgDisplay !== "") + (nameDisplay !== "") + (goalDisplay !== "") + (valueDisplay !== "") + (seenDisplay !== "")

			var dim = [focus.select(".line-name").node().getBBox().width,
						focus.select(".line-goal").node().getBBox().width,
						focus.select(".line-value").node().getBBox().width,
						focus.select(".line-seen").node().getBBox().width,
						focus.select(".line-comp").node().getBBox().width,
						focus.select(".line-budg").node().getBBox().width],

				rectX = (18 + d3.max(dim)) > 100 ? (18 + d3.max(dim)) : 100;
			focus.select(".line-tooltip-box")
				.attr("width",rectX)
				.attr("height", 23*dimHeight);
			// so it's never cut off
			if (isLeft) {var xPos = xScale(d.Month)} else {var xPos = xScale(d.Month) - rectX }
			if (isTop) {var yPos = yScale(d.Value) } else {var yPos = yScale(d.Value) - 23*dimHeight }
			focus.attr("transform","translate(" + xPos + "," + yPos + ")");
			focus.raise()
			d3.select(".line-overlay").raise()
		}

		function renderOverlays(container) {
			var g = d3.select(container).select("svg g.line-chart");

			var xAxis = d3.axisBottom(xScale).ticks(d3.timeMonth)
			var yAxis = d3.axisRight(yScale).tickSize(width)

			g.selectAll(".focus-line").remove()

			focus = g.append("g")
				.attr("class","focus-line label")
				.attr("visibility","hidden");


			g.append("rect")
				.attr("class","line-overlay")
				.attr("width", width)
				.attr("height",height)
				.attr("transform","translate("+ 0 + "," + 0 + ")")
				.on("mouseover",function(){focus.attr("visibility","visible")})
				.on("mouseout",function(){focus.attr("visibility","hidden")})
				.on("mousemove", mousemove1);

			g.selectAll(".line-title").remove()

			g.append("text")
				.attr("class","line-title")
				.attr("x", 60)
				.attr("y", 0 -(margin.top/2))
				.attr("text-decoration", "underline")
				.style("font-size","22px")
				.text(currentMeasure + " Over Time")




		}

		function chart(selection) {
			selection.each(function(d) {

				if(!currentMeasure | !currentProvider) {
					return; }

				init(d);


				var g = d3.select(this).select("svg g.line-chart");

				// check if chart is created
				var update = g["_groups"][0][0] !== undefined;  // true if data is being updated

				if(!update)
					initChart(this);


				g = d3.select(this).select("svg g.line-chart");
				
				// groups for lines
				var providerLayers = g.selectAll("g.provider")
					.data(useDataLine)
					.enter()
					.append("g")
						.classed("provider", true);

				providerLayers.exit().remove();

				// add line
				d3.selectAll("g.provider").transition()
					.duration(transitionDuration)
					.style("opacity", function(d) {
						if (!currentProvider) {
							return 1 //hover info here
						} else {
							if (d.key == currentProvider) {
								d3.select(this).raise();
								return 1;
							} else if (providerRef[0][d.key] === providerRef[0][currentProvider])
								{ return 0.1 + 0.1*(providerRef[0][d.key] != "Specialty 1");
							} else { return 0}

							}})
					.style("stroke", function(d) {
						if (!currentProvider) {
							return "#376374" //hover info here
						} else {
							if (d.key == currentProvider) {
								return "#376374";
							} else { return "#587E8D";}//"#e1e9ef"; }
							}})


				// lines
				var linePath = d3.selectAll("g.provider").selectAll("path")
					.data(function(d) {
						return [d];
					; });

				linePath.enter()
					.append("path");

				linePath.exit().remove();

				linePath.transition()
					.duration(transitionDuration)
					.attr("fill","none")
					.attr("d",function(d) {return line(d.value);})
					.style("stroke-width", function(d) {
						if (!currentProvider) {
							return "2px" 
						} else {
							if (d.key == currentProvider) {
								return "5px";
							} else { return "2px"; }
							}})

				// add points
				var pointLayer = d3.select("svg g.line-chart").selectAll("circle")
					.data(useDataLine.filter(function(d){ return d.key == currentProvider})[0].value)

				pointLayer.enter()
					.append("circle")
					.classed("line-point", true);

				pointLayer.exit().remove();

				d3.selectAll(".line-point").transition()
					.duration(transitionDuration)
					.attr("cy",function(d){d3.select(this).raise(); return yScale(d.Value)})
					.attr("cx",function(d){return xScale(d.Month)})
					.attr("r",function(d){return circleScale(d["Patients Seen"])})
					.attr("fill","white")
					.attr("stroke","steelblue")



				renderOverlays(this);
				// axes
				g.selectAll(".axis").remove()
				g.append("g")
					.attr("class","axis x-axis")
					.attr("transform", "translate(0," + height + ")")
					.transition()
					.duration(transitionDuration)
					.call(xAxis)


				g.append("g")
					.attr("class","axis y-axis")
					.transition()
					.duration(transitionDuration)
					.call(yAxis)



				g.selectAll(".y-axis .tick:not(:first-of-type) line").attr("stroke", "#777").attr("stroke-dasharray", "2,2");
				  g.selectAll(".y-axis .tick text").attr("dx", -width-20).attr("dy", -4);
				g.select(".y-axis .domain").remove();

				// focus for tooltip
				focus.append("rect")
					.attr("class","line-tooltip-box")
					.attr("width",100)
					.attr("height",115)
					.attr("fill","white")
					.attr("stroke","black")
					.attr("stroke-width",1)
					.style("opacity",1);

				focus.append("text")
					.attr("class","line-name")
					.attr("x",9)
					.attr("dy","1.35em")
					.style("font-size",15);
				focus.append("text")
					.attr("class","line-value")
					.attr("x",9)
					.attr("dy","2.7em")
					.style("font-size",15);
				focus.append("text")
					.attr("class","line-goal")
					.attr("x",9)
					.attr("dy","5.4em")
					.style("font-size",15);
				focus.append("text")
					.attr("class","line-comp")
					.attr("x",9)
					.attr("dy","4.05em")
					.style("font-size",15);
				focus.append("text")
					.attr("class","line-budg")
					.attr("x",9)
					.attr("dy","4.05em")
					.style("font-size",15);
				focus.append("text")
					.attr("class","line-seen")
					.attr("x",9)
					.attr("dy","6.75em")
					.style("font-size",15);

					
				// additional lines (Goals)
				var qualityLine = d3.selectAll("svg g.line-chart").selectAll(".qual-line")
					.data([useDataLine.filter(function(d){ return d.key == currentProvider})[0].value]);

				qualityLine.enter()
					.append("path")
					.classed("qual-line goal", true);

				qualityLine.exit().remove();

				d3.selectAll(".qual-line").transition()
					.duration(transitionDuration)
					.attr("d",function(d){return qualityGoal(d)})
					.attr("stroke","#B9A154")
					.attr("stroke-width",4)
					.attr("fill","none")

				var compLine = d3.selectAll("svg g.line-chart").selectAll(".comp-line")
					.data([useDataLine.filter(function(d){ return d.key == currentProvider})[0].value]);

				compLine.enter()
					.append("path")
					.classed("comp-line goal", true);

				compLine.exit().remove();

				d3.selectAll(".comp-line").transition()
					.duration(transitionDuration)
					.attr("d",function(d){ return compGoal(d)})
					.attr("stroke","#db3232")
					.attr("stroke-width",4)
					.attr("fill","none")

				var budgLine = d3.selectAll("svg g.line-chart").selectAll(".budg-line")
					.data([useDataLine.filter(function(d){ return d.key == currentProvider})[0].value]);

				budgLine.enter()
					.append("path")
					.classed("budg-line goal", true);

				budgLine.exit().remove();

				d3.selectAll(".budg-line").transition()
					.duration(transitionDuration)
					.attr("d",function(d){ return budgGoal(d)})
					.attr("stroke","#db3232")
					.attr("stroke-width",4)
					.attr("fill","none")

		})}

		// getters and setters
		chart.margin = function(_) {
			if (!arguments.length) return margin;
			margin = _;
			return chart;
		};
		chart.height = function(_) {
			if (!arguments.length) return height;
			height = _;
			return chart;
		};
		chart.width = function(_) {
			if (!arguments.length) return width;
			width = _;
			return chart;
		};
		chart.domain = function(_) {
			if (!arguments.length) return domain;
			domain = _;
			return chart;
		};
		chart.transitionDuration = function(_) {
			if (!arguments.length) return transitionDuration;
			transitionDuration = _;
			return chart;
		};
		chart.currentMonth = function(_) {
			if (!arguments.length) return currentMonth;
			currentMonth = _;
			return chart;
		};
		chart.currentProvider = function(_) {
			if (!arguments.length) return currentProvider;
			currentProvider = _;
			return chart;
		};
		chart.currentMeasure = function(_) {
			if (!arguments.length) return currentMeasure;
			currentMeasure = _;
			return chart;
		};
		chart.timeScale = function(_) {
			if (!arguments.length) return timeScale;
			timeScale = _;
			return chart;
		};
		chart.useDataLine = function(_) {
			if (!arguments.length) return useDataLine;
			useDataLine = _;
			return chart;
		};
			chart.focus = function(_) {
			if (!arguments.length) return focus;
			focus = _;
			return chart;
		};
		return chart;
	}



	function horizBar() {

		//configurables
		var margin = {top:105, right: 0, bottom:40, left:5}
			barHeight = 20,
			barColors = undefined,
			domain = [0,2],
			tickValues = undefined,
			transitionDuration = 300,
			height = 320,
			width = 360;

		var currentMonth = undefined,
			currentProvider = undefined,
			currentMeasure = undefined,
			usableVar = undefined,
			deleteKeys = undefined,
			monthList = undefined;
		// scales
		var numBars = null,
			barScale = null,
			keys = null,
			focus = null,
			useData = [];



		function init(d) {
			barScale = d3.scaleLinear().domain(domain).range([0, width]);

			keys = d[0][currentMonth][0][currentProvider].map(function(v) { return v.Measure});
			usableVarList = ["Measure 1","Measure 2","Measure 4","Measure 8","Measure 6","Measure 14","Measure 17","Measure 16","Measure 15","Measure 18","Measure 19", "Measure 10", "Measure 9"]
			usableVar = measureRef[0][providerRef[0][currentProvider]].filter(function(n) {return include(usableVarList,n)})
			if (providerRef[0][currentProvider] == "Specialty 2" || providerRef[0][currentProvider] == "Specialty 3"){usableVar.push("Measure 7")}
			if(!usableVar) { useKeys = keys } else { useKeys =  keys.filter(function(n){return include(usableVar,n)}) }

			var months = parseTime(currentMonth).getMonth()%3
			monthList = []
			for (var i = 0; i <= months; i++) {
				monthList.push(d3.timeMonth.offset(parseTime(currentMonth), -i).toString().slice(4,7) + "-" + d3.timeMonth.offset(parseTime(currentMonth), -i).toString().slice(13,15))
			}
			monthList = monthList.filter(function(n){return include(d3.map(data[0]).keys(), n)})
			deleteKeys =  keys.filter(function(n) { return !include(usableVar,n)})
			numBars = useKeys.length;

			useData = []
			for (m in d[0][currentMonth][0][currentProvider]) {
				var measure = d[0][currentMonth][0][currentProvider][m].Measure
				var vScore = []
				var pSeen = []
				for (j in monthList) {
					try {
					if(d[0][monthList[j]][0][currentProvider].filter(function(i){return i.Measure === measure})[0] != undefined){
					var tempScore = d[0][monthList[j]][0][currentProvider].filter(function(i){return i.Measure === measure})[0].Score
					var tempSeen = d[0][monthList[j]][0][currentProvider].filter(function(i){return i.Measure === measure})[0]["Patients Seen"]
					//if(d[0][monthList[j]][0][currentProvider].filter(function(i){return i.Measure === 'Third Next'})[0].Value == 0){ tempScore = 2}
					vScore.push(isNumeric(tempScore) ?  tempScore : 0)
					pSeen.push((tempSeen == undefined) ? 1 : tempSeen == '' ? 0 : tempSeen)}
					} catch(err) {}
				}
				var exportValue = pSeen.reduce(function(r,a,k){return r+a*vScore[k]},0) / pSeen.reduce(function(j,l){return j+l})
				measureDat = { Measure: measure,
								Score:   pSeen.reduce(function(j,l){return j+l}) != 0 ? exportValue : 1}
				useData.push(measureDat)
			}
		}


		function svgTranslate(x,y){
			return "translate("+ +x + ","+ +y +")";
		}

		function bisectData(bars, angle) {
			var angular = 360 / bars
			return Math.floor(angle/angular)
		}

		function mousemove() {
			var a0 = angleFinder(d3.mouse(this)[0], d3.mouse(this)[1]),
				i = bisectAngle(numBars, a0),
			//  d0 = ,
			//  d1 = ,
				d = useData[i];
			var isLeft = (d3.mouse(this)[0] < barHeight),
				isTop = (d3.mouse(this)[1] < barHeight);
			var nameDisplay = d.Measure,
				valueDisplay = "Score: " + d.Value
			if(!d["Patients Seen"]) { var seenDisplay = ""} else {var seenDisplay = d["Patients Seen"] + " Patients Seen";}

			if(!d["Quality Goal"]) {var goalDisplay = ""
			} else if(d["Quality Goal"] < 1.01) {var goalDisplay = "Quality Goal: " + (100*d["Quality Goal"]) + "%"
			} else if (d["Quality Goal"] > 1000) {var goalDisplay = "Quality Goal: $" + formatValue(d["Quality Goal"])
			} else {var goalDisplay = "Quality Goal: " + d["Quality Goal"]}
			if(!d["Compensation Threshold"]) {var compDisplay = ""
			} else if(d["Compensation Threshold"] < 1.01) {var compDisplay = "Comp Goal: " + (100*d["Compensation Threshold"]) + "%"
			} else if (d["Compensation Threshold"] > 1000) {var compDisplay = "Comp Goal: $" + formatValue(d["Compensation Threshold"])
			} else {var compDisplay = "Comp Goal: " + d["Compensation Threshold"]}
			if(d["Value"] <= 1) {var valueDisplay = "Score: " + formatValue(100*d.Value) + "%"
			} else if (d["Value"] > 1000) {var valueDisplay = "Score: $" + formatValue(d.Value)
			} else {var valueDisplay = "Score: " + d.Value}

			focus.select(".horiz-name").text(nameDisplay)
			focus.select(".horiz-goal").text(goalDisplay)
			focus.select(".horiz-value").text(valueDisplay)
			focus.select(".horiz-seen").text(seenDisplay)
			focus.select(".horiz-comp").text(compDisplay)
			var dim = [focus.select(".horiz-name").node().getBBox().width,
						focus.select(".horiz-goal").node().getBBox().width,
						focus.select(".horiz-value").node().getBBox().width,
						focus.select(".horiz-seen").node().getBBox().width,
						focus.select(".horiz-comp").node().getBBox().width]

				rectX = (18 + d3.max(dim)) > 100 ? (18 + d3.max(dim)) : 100;
			focus.select("rect")
				.attr("width",rectX);
			if (isLeft) {var xPos = d3.mouse(this)[0] - barHeight + 9 } else {var xPos = d3.mouse(this)[0] - barHeight - rectX }
			if (isTop) {var yPos = d3.mouse(this)[1] - barHeight } else {var yPos = d3.mouse(this)[1] - barHeight - 115 }
			focus.attr("transform","translate(" + xPos + "," + yPos + ")");
		}

		function click(a, e) {
			var i = Math.round((e[1] - (margin.top + 15))/(10 + barHeight))
			selectorMeasure.select(".menu")
				.property("value", useData[i].Measure);
			updateMeasure(useData[i].Measure);

		}

		function initChart(container) {
			var g = d3.select(container)
						.append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.classed("horiz-barchart",true)
							.attr("transform",svgTranslate(margin.left, margin.top));

		}

		function renderOverlays(container) {
			var g = d3.select(container).select("svg g.horiz-barchart");
			g.selectAll(".focus").remove()
			g.selectAll(".horiz-overlay").remove()



			//axis
			var axisScale = d3.scaleLinear().domain(domain).range
			var axis = d3.axisBottom().scale(barScale).tickFormat(function(d) { return d == 1 ? "Compensation Threshold" : 0})

			g.selectAll(".horiz-axis").remove()

			if(tickValues)
				axis.tickValues(tickValues);
			g.append("g")
				.attr("transform", "translate(" + margin.left + "," + (margin.top  + (10 + barHeight)*numBars) + ")")
				.classed("horiz-axis",true)
				.call(axis)
			.selectAll("text")
				.call(wrap, 80);

			d3.selectAll(".bar-title").remove()

			g.append("text")
				.attr("class","bar-title")
				.attr("x", margin.left + width + margin.right - 15)
				.attr("y", 25)
				.attr("text-decoration", "underline")
				.attr("text-anchor","end")
				.style("font-size","20px")
				.text("QtD Goals:")
			g.append("text")
				.attr("class","bar-title")
				.attr("x", margin.left + width + margin.right - 15)
				.attr("y", 50)
				.attr("text-decoration", "underline")
				.attr("text-anchor","end")
				.style("font-size","20px")
				.text("Compensation")

	//tooltip
	/*      focus = g.append("g")
				.attr("class","focus label")
				.attr("visibility","hidden");


			g.append("rect")
				.attr("class","horiz-overlay")
				.attr("width", width)
				.attr("height",height)
				.attr("transform","translate("+ margin.left + "," + margin.top + ")")
				.on("mouseover",function(){focus.attr("visibility","visible")})
				.on("mouseout",function(){focus.attr("visibility","hidden")})
				//.on("mousemove", mousemove);
				*/
		}
		function chart(selection) {
			selection.each(function(d) {

				// d[Patients Seen] == undefined ? 1: d[patients seen]
				// d.score == undefined ? 0 : d.score
				//works for now not for later
				if(!currentMeasure) {
					return }

				if(!currentProvider) {
					return }

				//useData = clone(d[0][currentMonth][0][currentProvider])

				init(d);
				var g = d3.select(this).select("svg g.horiz-barchart");

				// check if chart is created
				var update = g["_groups"][0][0] !== undefined;  // true if data is being updated
				if(!update)
					initChart(this);

				g = d3.select(this).select("svg g.horiz-barchart");

				if(usableVar) { for ( var k in deleteKeys) {
					var checker = deleteKeys[k]
					for (var j in useData) {
						if (useData[j].Measure === checker) {
							delete useData[j]
					}}}}
				useData = useData.filter(function(n) { return n != undefined})

				var layers = g.selectAll("g.layer")
					.data([1])



				layers.enter()
					.append("g")
					.attr("class",function(d,i){
						return "layer-" + i;
					})
					.classed("layer",true);


				layers.exit().remove();

				var bars = d3.select("g.layer").selectAll("rect")
					.data(useData)


				bars.enter()
					.append("rect")
					.attr("class","comp-bar")
				bars.exit().remove();

				bars.transition()
					.duration(transitionDuration)
					.style("fill", function(d,i) {
					if(!currentMeasure) { return "#376374"; } else {
						if (d.Measure == currentMeasure) {return "#224F60"} else { return "#587E8D"}}
					})
	//              .style("fill", function(d,i) {
	//              if(!currentMeasure) { return "steelblue"; } else {
	//                  if (d.Score >= 1) {return "green"} else { return "red"}}
	//              })
					.style("opacity", function(d,i) {
					if(!currentMeasure) { return 1; } else {
						if (d.Measure == currentMeasure) {return 1} else { return 0.85}}
					})
					.attr("width",function(d) {return barScale(d.Score); })
					.attr("height",barHeight)
					.attr("x", margin.left)
					.attr("y",function(d, i){return (margin.top  + (10 + barHeight)*i)});

				var bartext = d3.select("g.layer").selectAll("text")
					.data(useData);


				bartext.enter()
					.append("text")
				bartext.exit().remove();

				bartext.transition()
					.duration(transitionDuration)
					.style("fill", "white")
					.style("paint-order", "stroke")
					.style("stroke-width","3px")
					.style("stroke","black")
					.attr("x", margin.left + 10)
					.attr("y",function(d, i){return (margin.top + 15 + (10 + barHeight)*i)})
					.text(function(d) {return d.Measure});

				bars.on("mouseover",function(d) {d3.select(this).style("fill","#0D3645")})
					.on("mouseout",function(d) {d3.select(this).style("fill", function(d,i) {
					if(!currentMeasure) { return "#376374"; } else {
						if (d.Measure == currentMeasure) {return "#224F60"} else { return "#587E8D"}}
					})})


				var goalLine = g.selectAll("line")
					.data([1])

				goalLine.enter()
					.append("line")
					.classed("horiz-goal-line",true);


				goalLine.exit().remove()

				goalLine.transition()
					.duration(transitionDuration)
					.attr("x1", margin.left + barScale(1))
					.attr("x2", margin.left + barScale(1))
					.attr("y1",margin.top)
					.attr("y2",(margin.top  + (10 + barHeight)*numBars))
					.attr("stroke","#db3232")
					.attr("stroke-width",4)
					.attr("fill","none")

				goalLine.raise()
			//  if(!update){
				renderOverlays(this);

				g.on("click", function() {click(0, d3.mouse(this))})

			});


		}
		// getters and setters
		chart.margin = function(_) {
			if (!arguments.length) return margin;
			margin = _;
			return chart;
		};
		chart.monthList = function(_) {
			if (!arguments.length) return monthList;
			monthList = _;
			return chart;
		};
		chart.barHeight = function(_) {
			if (!arguments.length) return barHeight;
			barHeight = _;
			return chart;
		};
		chart.barColors = function(_) {
			if (!arguments.length) return barColors;
			barColors = _;
			return chart;
		};
		chart.capitalizeLabels = function(_) {
			if (!arguments.length) return capitalizeLabels;
			capitalizeLabels = _;
			return chart;
		};
		chart.domain = function(_) {
			if (!arguments.length) return domain;
			domain = _;
			return chart;
		};
		chart.tickValues = function(_) {
			if (!arguments.length) return tickValues;
			tickValues = _;
			return chart;
		};
		chart.colorLabels = function(_) {
			if (!arguments.length) return colorLabels;
			colorLabels = _;
			return chart;
		};
		chart.transitionDuration = function(_) {
			if (!arguments.length) return transitionDuration;
			transitionDuration = _;
			return chart;
		};
		chart.currentMonth = function(_) {
			if (!arguments.length) return currentMonth;
			currentMonth = _;
			return chart;
		};
		chart.currentProvider = function(_) {
			if (!arguments.length) return currentProvider;
			currentProvider = _;
			return chart;
		};
		chart.usableVar = function(_) {
			if (!arguments.length) return usableVar;
			usableVar = _;
			return chart;
		};
		chart.currentMeasure = function(_) {
			if (!arguments.length) return currentMeasure;
			currentMeasure = _;
			return chart;
		};
		chart.deleteKeys = function(_) {
			if (!arguments.length) return deleteKeys;
			deleteKeys = _;
			return chart;
		};
		chart.focus = function(_) {
			if (!arguments.length) return focus;
			focus = _;
			return chart;
		};
		chart.useData = function(_) {
			if (!arguments.length) return useData;
			useData = _;
			return chart;
		};
		chart.height = function(_) {
			if (!arguments.length) return height;
			height = _;
			return chart;
		};
		chart.width = function(_) {
			if (!arguments.length) return width;
			width = _;
			return chart;
		};
		return chart;
	}


	// helper for numeric values
	function isNumeric(n) {
	  return !isNaN(parseFloat(n)) && isFinite(n);
	}
	
	// helper function to create a deep clone of an object
	function clone(obj) {
		if(obj == null || typeof(obj) != "object")
			return obj;
		var temp = new obj.constructor();
		for(var key in obj)
			temp[key] = clone(obj[key]);
		return temp;
	}
	//find percentile
	function percentRank(array, n) {
		var L = 0;
		var S = 0;
		var N = array.length

		for (var i = 0; i < array.length; i++) {
			if (array[i] < n) {
				L += 1
			} else if (array[i] === n) {
				S += 1
			} else {

			}
		}

		var pct = (L + (0.5 * S)) / N

		return pct
	}
	// function for formatting ordinals - for percentile 
	function ordinal_suffix_of(i) {
		var j = i % 10,
			k = i % 100;
		if (j == 1 && k != 11) {
			return i + "st";
		}
		if (j == 2 && k != 12) {
			return i + "nd";
		}
		if (j == 3 && k != 13) {
			return i + "rd";
		}
		return i + "th";
	}

	function include(arr,obj) {
		return (arr.indexOf(obj) != -1);
	}
	
	//wrap SVG text based on a given width
	function wrap(text, width) {
	  text.each(function() {
		var text = d3.select(this),
			words = text.text().split(/\s+/).reverse(),
			word,
			line = [],
			lineNumber = 0,
			lineHeight = 1.1, // ems
			y = text.attr("y"),
			dy = parseFloat(text.attr("dy")),
			tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
		while (word = words.pop()) {
		  line.push(word);
		  tspan.text(line.join(" "));
		  if (tspan.node().getComputedTextLength() > width) {
			line.pop();
			tspan.text(line.join(" "));
			line = [word];
			tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
		  }
		}
	  });};



// recall charts based on changes to dropdowns 
	function updateUser(name) {
		//d3.select("svg").remove()
		if (name == "Select...") {
			chart.currentProvider(undefined)
			chart2.currentProvider(undefined)
			chart3.currentProvider(undefined)
			} else {
			chart.currentProvider(name)
			chart2.currentProvider(name)
			chart3.currentProvider(name)

			var currentMeasure = selectorMeasure.select(".menu")
						.property("value");
			var currentMonth = selectorMonth.select(".menu")
				.property("value");

			if(!include(measureRef[0][providerRef[0][name]], currentMeasure)){
				currentMeasure = measureRef[0][providerRef[0][name]][0]}


			chart.currentMeasure(currentMeasure)
			chart2.currentMeasure(currentMeasure)
			chart3.currentMeasure(currentMeasure)



			selectorMeasure.selectAll("option").remove();
			selectorMeasure.exit()

			selectorMeasure.select("select").selectAll("option")
				.data(measureRef[0][providerRef[0][name]])
				.enter()
				.append("option")
					.attr("value", function(d) {return d;})
					.text(function(d) {return d;});

			};

			selectorMeasure.select(".menu")
						.property("value", currentMeasure);

		d3.select(".graph1-container")
			  .datum(data)
			  .call(chart);

		d3.select(".graph2-container")
			  .datum(data)
			  .call(chart2);
		d3.selectAll(".table-container table").remove()
		if (name != "Select...") {
		tableChart(data[0][currentMonth][0][name], d3.select(".table-container")) }

		d3.select(".graph3-container")
			  .datum(data)
			  .call(chart3);
	}

	function updateMeasure(m) {
		//d3.select("svg").remove()
		if (m == "Select...") {
			chart.currentMeasure(undefined)
			chart2.currentMeasure(undefined)
			chart3.currentMeasure(undefined)

			} else {
			chart.currentMeasure(m)
			chart2.currentMeasure(m)
			chart3.currentMeasure(m)

			};

		d3.select(".graph1-container")
			  .datum(data)
			  .call(chart);

		d3.select(".graph2-container")
			  .datum(data)
			  .call(chart2);

		d3.select(".graph3-container")
			  .datum(data)
			  .call(chart3);


	}
	function updateMonth(mo) {
		//d3.select("svg").remove()
		if (mo == "Select...") {
			chart.currentMonth(undefined)
			chart2.currentMonth(undefined)
			chart3.currentMonth(undefined)

			} else {
			chart.currentMonth(mo)
			chart2.currentMonth(mo)
			chart3.currentMonth(mo)

			};
		var name = selectorProvider.select(".menu")
				.property("value");
		d3.select(".graph1-container")
			  .datum(data)
			  .call(chart);

		d3.select(".graph2-container")
			  .datum(data)
			  .call(chart2);

		d3.select(".graph3-container")
			  .datum(data)
			  .call(chart3);

		d3.selectAll(".table-container table").remove()
		tableChart(data[0][mo][0][name], d3.select(".table-container"))



	}
})
